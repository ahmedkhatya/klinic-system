<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</title>
    <style>
        body { font-family: 'Segoe UI'; background: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .search-bar { display: flex; gap: 10px; margin: 20px 0; }
        input, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #f1f3f4; }
        .btn-add { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;}
        .logout-link { color: #d93025; text-decoration: none; font-weight: bold; }
        .btn-whatsapp { background: #25d366; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 5px; }
        .btn-print { background: #607d8b; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ø³Ø¬Ù„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø°ÙƒÙŠ ğŸ“‚</h1>
            <a href="/logout" class="logout-link">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
        </div>

        <form class="search-bar" action="/" method="GET">
            <input type="text" name="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„..." style="flex: 1;">
            <button type="submit" style="background:#1a73e8; color:white; border:none; padding:10px 25px; border-radius:8px; cursor:pointer;">Ø¨Ø­Ø«</button>
            <a href="/" style="text-decoration:none; padding-top:10px; margin-right: 10px;">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</a>
        </form>

        <details style="background:#e3f2fd; padding:15px; border-radius:10px; margin-bottom:20px;">
            <summary style="font-weight:bold; cursor:pointer; color: #1a73e8;">+ ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</summary>
            <form action="/add" method="POST" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <input type="text" name="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" required>
                <input type="text" name="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" id="new_phone">
                <input type="number" name="age" placeholder="Ø§Ù„Ø³Ù†">
                <textarea name="history" placeholder="Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„Ø±ÙˆØ´ØªØ©..." style="grid-column: span 2; height: 100px;"></textarea>
                <button type="submit" class="btn-add" style="grid-column: span 2;">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </form>
        </details>

        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø±ÙŠØ¶</th>
                    <th>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</th>
                    <th>Ø§Ù„Ø³Ù†</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody>
                {% for p in patients %}
                <tr>
                    <td><strong>{{ p[1] }}</strong></td>
                    <td>{{ p[2] }}</td>
                    <td>{{ p[3] }}</td>
                    <td>{{ p[4] }}</td>
                    <td>
                        <button onclick="sendWhatsApp('{{ p[2] }}', '{{ p[4] }}')" class="btn-whatsapp">ÙˆØ§ØªØ³Ø§Ø¨ ğŸ“±</button>
                        <button onclick="printPrescription('{{ p[1] }}', '{{ p[3] }}', '{{ p[4] }}')" class="btn-print">Ø·Ø¨Ø§Ø¹Ø© ğŸ–¨ï¸</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
    function sendWhatsApp(phone, history) {
        if(!phone || phone === 'None') { alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­"); return; }
        let cleanPhone = phone.replace(/\D/g, '');
        if (cleanPhone.startsWith('01') && cleanPhone.length === 11) { cleanPhone = '2' + cleanPhone; }
        
        let message = `*Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ©*\n\n*Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:*\n${history}`;
        let url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank').focus();
    }

    function printPrescription(name, age, history) {
        let printWindow = window.open('', '_blank', 'height=600,width=800');
        if (!printWindow) {
            alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Pop-ups) Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­");
            return;
        }
        printWindow.document.write('<html><head><title>Ø±ÙˆØ´ØªØ©</title>');
        printWindow.document.write('<style>body{font-family:Arial; direction:rtl; padding:40px; border:2px solid #000;} .header{text-align:center; border-bottom:1px solid #000; margin-bottom:20px;}</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write('<div class="header"><h1>Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ©</h1></div>');
        printWindow.document.write('<p><b>Ø§Ù„Ù…Ø±ÙŠØ¶:</b> ' + name + ' &nbsp;&nbsp;&nbsp; <b>Ø§Ù„Ø³Ù†:</b> ' + age + '</p>');
        printWindow.document.write('<hr><p><b>Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„Ø£Ø¯ÙˆÙŠØ©:</b><br><br>' + history.replace(/\n/g, '<br>') + '</p>');
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        
        setTimeout(function() {
            printWindow.print();
            printWindow.close();
        }, 500);
    }
    </script>
</body>
</html>